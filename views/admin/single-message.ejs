<%- include('../includes/head.ejs') %>
<link rel="stylesheet" href="/assets/css/badges.css">
<link rel="stylesheet" href="/assets/css/email-messages.css">
</head>

<body class="messages-admin">


    <% if(errorMessage && errorMessage.length> 0) { %>
    <div class="flash-message error" style="display: block">
        <%= errorMessage %>
            <span class="close-button">&times;</span>
    </div>
    <% } %>
            <% if(successMessage && successMessage.length> 0) { %>
    <div class="flash-message success" style="display: block">
        <%= successMessage %>
            <span class="close-button">&times;</span>
    </div>
    <% } %>

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header -->
        <!-- Menu -->
        <%- include('../includes/navigation.ejs') %>

            <!-- Main -->
            <div id="main">

                <header>
                    <h1>История сообщений</h1>
                </header>



                <!-- Messages -->
                <% if (messages && messages.length> 0) { %>
                    <% for (let message of messages) { %>
                        <article class="post message-item"  id="message-<%= message.id %>">
                           
                            <header>
                                <div class="title user-message-info">
                                    <h3>Сообщение от <%= message.firstname %> <%= message.lastname %></h3>
                                    <p>Email: <a href="mailto:<%= message.email %>"><%= message.email %></a></p>
                                    <span class="message-status status-<%= message.status %>">
                                        <%= message.status === 'new' ? 'Новое' : 
                                           message.status === 'in_progress' ? 'В работе' : 
                                           message.status === 'replied' ? 'Отвечено' :
                                           message.status === 'userReply' ? 'Ответ пользователя' : 
                                           message.status === 'adminReply' ? 'Ответ администратора' : 'Закрыто' %>
                                    </span>
                                </div>
                                <div class="meta message-details">
                                    <time class="published" datetime="<%= message.createdAt %>">
                                        <%= formatDate(message.createdAt) %>
                                    </time>
                                    <% if (message.repliedAt) { %>
                                    <time class="published">
                                        Отвечено: <%= formatDate(message.repliedAt) %>
                                    </time>
                                    <% } %>
                                </div>
                            </header>

                            <div class="message-content">
                                <strong><%= message.firstname %> <%= message.lastname %>:</strong>
                                <p><%- message.content %></p>
                            </div>
                            <% if(message.parent) { %>
                            <div class="message-content parent">
                                <strong>Ответ на сообщение:</strong>
                                <p>От: <span><%- message.parent.firstname %> <%- message.parent.lastname %></span></p>
                                <p><%- message.parent.content %></p>
                                <small><%= formatDate(message.parent.createdAt) %></small>
                            </div>
                            <a href="#message-<%= message.parent.id %>" class="goto-parent-link">
                                Перейти к оригинальному сообщению ↑
                            </a>
                            <% } %>
                            <footer class="<%= (message.status !== 'adminReply') ? '' : 'messages-footer-hiden' %>">
                                <ul class="actions admin-messages-list">
                                    <% if (message.status !== 'adminReply') { %>
                                    <li class="admin-messages-item">
                                        <button type="button" class="button large toggle-reply-form-btn" data-message-id="<%= message.id %>">
                                            Ответить <i class="bi bi-reply"></i>
                                        </button>
                                    </li>
                                    <li class="admin-messages-item">
                                        <form method="POST" action="/admin/messages/<%= message.id %>/status?fromPage=single-message&threadId=<%= message.threadId %>" class="admin-messages-form" enctype="application/x-www-form-urlencoded">
                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                            <select name="status" class="admin-messages-select">
                                                <% if (message.status === 'userReply') { %>
                                                    <option value="userReply" <%= message.status === 'userReply' ? 'selected' : '' %>>Ответ пользователя</option>                                            
                                                    <% } else { %>
                                                        <option value="new" <%= message.status === 'new' ? 'selected' : '' %>>Новое</option>                                            
                                                        <% } %>
                                              
                                                <option value="in_progress" <%= message.status === 'in_progress' ? 'selected' : '' %>>В работе</option>
                                                <% if (message.status !== 'new' && message.status !== 'userReply') { %>
                                                <option value="replied" <%= message.status === 'replied' ? 'selected' : '' %>>Отвечено</option>
                                                <% } %>
                                         
                                            </select>
                                        </form>
                                    </li>
                                    <% } %>
                                </ul>
                            </footer>

                            <!-- Reply Form -->
                            <div id="reply-form-<%= message.id %>" class="reply-form">
                                <h3>Отправить ответ</h3>
                                <form method="POST" action="/admin/messages/<%= message.id %>/reply">
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                    <input type="hidden" name="userEmail" value="<%= message.email %>">
                                    <input type="hidden" name="originalMessage" value="<%= message.content.replace(/"/g, '&quot;') %>">
                                    <input type="hidden" name="fromPage" value="single-message">
                                    <input type="hidden" name="threadId" value="<%= threadId %>">
                                    
                                    <div class="form-group">
                                        <label>Тема:</label>
                                        <input type="text" name="subject" class="form-control" value="Re: Сообщение от <%= formatDateOnly(message.createdAt) %>" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Сообщение:</label>
                                        <textarea name="replyContent" class="form-control" rows="6" required></textarea>
                                    </div>
                                    
                                    <div class="form-group actions">
                                        <button type="submit" class="button primary">Отправить ответ</button>
                                        <button type="button" class="button toggle-reply-form-btn" data-message-id="<%= message.id %>">Отмена</button>
                                    </div>
                                </form>
                            </div>

                        </article>
                        <% } %>
                            <% } else { %>
                                <h2>Сообщений нет</h2>
                                <p>Пока никто не отправлял сообщений.</p>
                                <% } %>



            </div>
            <!-- Sidebar -->
            <section id="sidebar">

                <!-- Intro -->
                <section id="intro">
                    <header>
                        <a href="#" class="logo"><img src="/images/logo.jpg" alt="" /></a>
                        <h2>Сообщения от пользователя</h2>
                         <p>
                        <span><%= userData.firstname || '' %></span>
                        <span><%= userData.lastname || '' %></span>
                    </p>
                    <p><%= userData.email || '' %></p>
                    </header>
                </section>

                <!-- Stats -->
                <section>
                    <h3>Статистика сообщений</h3>
                    <div class="mini-posts">
                        <article class="mini-post">
                            <header>
                                <h3>Всего сообщений: <%= totalMessages || 0 %></h3>
                            </header>
                        </article>
                        <article class="mini-post <%= newMessages > 0 ? 'status-new' : '' %>">
                            <header>
                                <h3>Новых: <%= newMessages || 0 %></h3>
                            </header>
                        </article>
                        <article class="mini-post">
                            <header>
                                <h3>Отвечено: <%= repliedMessages || 0 %></h3>
                            </header>
                        </article>
                        <article class="mini-post">
                            <header>
                                <h3>Ответы администрации: <%= adminMessages || 0 %></h3>
                            </header>
                        </article>
                    </div>
                </section>
                 <section>
                    <h3>Быстрые действия</h3>
                    <ul class="actions">
                        <li class="actions-item"><a href="/email/check-email?threadId=<%= threadId %>" class="button large">Обновить сообщения</a></li>
                    </ul>
                </section>
                <!-- Quick Actions -->
                <section>
                    <h3>Быстрые действия</h3>
                    <ul class="actions vertical-list">
                        <li class="vertical-item"><a href="/admin/messages/<%= threadId %>?status=new" class="button">Новые сообщения</a></li>
                        <li class="vertical-item"><a href="/admin/messages/<%= threadId %>?status=in_progress" class="button">В работе</a></li>
                        <li class="vertical-item"><a href="/admin/messages/<%= threadId %>?status=replied" class="button">Отвеченные</a></li>
                        <li class="vertical-item"><a href="/admin/messages/<%= threadId %>" class="button">Все</a></li>
                    </ul>
                </section>

                <!-- About -->
                <section class="blurb">
                    <h2>Информация</h2>
                    <p>Здесь вы можете управлять сообщениями от пользователей, отвечать на них и отслеживать статус обработки.</p>
                    <ul class="actions">
                        <li><a href="/admin/messages" class="button large">Назад в админ сообщения</a></li>
                    </ul>
                </section>

<%- include('../includes/footer.ejs') %>
<%- include('../includes/main-scripts.ejs') %>



<script src="/assets/js/email/messageFormHandler.js"></script>
<%- include('../includes/scripts.ejs') %>